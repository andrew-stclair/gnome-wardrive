# GNOME Wardrive - Copilot Instructions

## Privacy and Security Guidelines

### ⚠️ CRITICAL: Personal Information Protection

**DO NOT include any real personally identifiable information (PII) in:**
- Code examples or documentation
- Testing data or sample outputs
- Debug logs or console output examples
- GPS coordinates or location data
- WiFi network names (SSIDs) or MAC addresses (BSSIDs)
- Any real-world network information

**Use generic placeholder data:**
- GPS coordinates: Use generic examples like "40.7128, -74.0060" (NYC coordinates)
- Network names: Use placeholders like "ExampleNetwork", "WiFi_Network_1"
- MAC addresses: Use documentation-safe examples like "00:11:22:33:44:55"
- Always sanitize real data before including in documentation

**Privacy-first development:**
- Test with mock/synthetic data when possible
- Redact real information from logs and examples
- Use privacy-preserving examples in all documentation
- Ensure no real location or network data leaks into the codebase

## Project Overview

GNOME Wardrive is a modern WiFi wardriving application built for the GNOME desktop using Python, GTK4, and Libadwaita. The application is designed to be **completely portable** and work seamlessly inside Flatpak sandboxes without requiring any system configuration changes.

## Core Architecture

### Application Structure
```
src/
├── main.py              # Application entry point
├── application.py       # Main Adwaita.Application class
├── window.py           # Main window with GTK4 template
├── wifi_scanner.py     # Portable WiFi monitoring service
├── location_service.py # GeoClue GPS integration  
├── data_manager.py     # Data export (CSV, KML, GPX)
└── __init__.py

data/
├── ui/
│   ├── window.ui           # Main GTK4 interface
│   └── window_simple.ui    # Simplified interface template
├── meson.build                          # Build configuration
├── com.andrewstclair.Wardrive.gschema.xml # GSettings schema
└── gnome-wardrive.gresource.xml          # UI resources
```

### Key Design Principles

1. **Mobile-First Design**: Optimized primarily for mobile devices with adaptive desktop support
2. **System WiFi Scanning**: Uses NetworkManager's passive monitoring through native D-Bus integration
3. **Native GNOME Integration**: Full D-Bus integration with NetworkManager and GeoClue
4. **Touch-Friendly Interface**: 48px minimum touch targets, responsive layouts, adaptive UI patterns
5. **Cross-Platform Compatibility**: Works on mobile devices, desktops, and different distributions
6. **No System Configuration**: Zero setup required from users - works out of the box

## Critical Implementation Details

### WiFi Scanning Architecture (IMPORTANT!)

The application uses a **passive WiFi monitoring** approach that is critical for portability:

**❌ DO NOT use active scanning approaches that require:**
- Special user permissions (netdev group)
- PolicyKit rule modifications
- System configuration changes
- Elevated privileges

**✅ DO use the current passive monitoring approach:**
- Monitor NetworkManager's cached access point data
- Attempt active scans but gracefully fall back to passive
- Rely on natural network discovery from beacon frames and system scans
- Works identically inside Flatpak sandboxes

### Location Services Integration

Uses direct D-Bus calls to GeoClue2 with proper application identification:
- Set `DesktopId` property to match application ID
- Set `RequestedAccuracyLevel` for GPS precision
- Handle location updates via D-Bus signals
- Graceful degradation if location services unavailable

### Data Export Formats

Support multiple standard formats for wardriving data:
- **CSV**: Raw tabular data for analysis
- **KML**: Google Earth compatible mapping
- **GPX**: GPS track format with waypoints

## Testing Requirements

### 1. Basic Functionality Test
```bash
# Run the WiFi scanning test
python3 test-wifi-scanning.py

# Expected output: Should detect visible WiFi networks without errors
# ✅ Portable WiFi scanning is working!
```

### 2. Application Launch Test  
```bash
# Quick development test
./quick-test.sh

# Expected: Clean startup with no permission errors
# Should show: "✅ Portable WiFi scanning ready"
```

### 3. Full Development Test
```bash
# Build and run via Meson
meson setup builddir
ninja -C builddir
python3 run-dev.py

# Expected output should include:
# - "Found X WiFi devices"
# - "✅ Location service started successfully" 
# - NO authentication or permission warnings
```

### 4. Package Build Test
```bash
# Build Debian package
./build-deb.sh

# Install and test
sudo dpkg -i gnome-wardrive_*.deb
```

### 5. CI Artifact Testing
```bash
# Download Debian package from GitHub Actions artifacts
# Available for every commit on main/develop branches and PRs
# Artifact name: gnome-wardrive-flatpak-{run_number}-{commit_sha}

# Test installation:
flatpak install com.andrewstclair.Wardrive.flatpak
flatpak run com.andrewstclair.Wardrive
```

## Flatpak Portability Requirements

### Mandatory Characteristics

1. **Zero System Configuration**: Application must work immediately after Flatpak installation
2. **Sandbox Compatible**: Full functionality within Flatpak's security model
3. **Permission Minimal**: Only request essential D-Bus permissions
4. **Graceful Degradation**: Handle permission denials without breaking

### Required Flatpak Permissions

```yaml
finish-args:
  - --share=network                                    # Network access
  - --system-talk-name=org.freedesktop.NetworkManager # WiFi monitoring  
  - --system-talk-name=org.freedesktop.GeoClue2      # GPS location
  - --filesystem=home                                  # Data export
  - --socket=wayland                                   # Display
  - --socket=fallback-x11                             # X11 fallback
  - --share=ipc                                        # IPC for GUI
  - --device=dri                                       # Hardware acceleration
```

**❌ NEVER add these permissions** (breaks portability):
- `--filesystem=host` (too broad)
- `--system-talk-name=org.freedesktop.PolicyKit1` (requires system changes)
- `--device=all` (security risk)

### Testing Flatpak Portability

When making changes, always verify:

1. **No Permission Errors**: Application starts clean in sandbox
2. **WiFi Detection Works**: Networks discovered without active scan permissions
3. **Location Services Work**: GPS coordinates obtained via GeoClue D-Bus
4. **Data Export Works**: Files can be saved to user's home directory
5. **UI Responsive**: GTK4/Libadwaita interface works properly

## Mobile UI Guidelines (GNOME HIG Compliant)

### GNOME Human Interface Guidelines Compliance

1. **Minimum Touch Targets**: All interactive elements must be at least 48x48px
2. **Responsive Layouts**: Use AdwClamp for content width management (max 600px)
3. **Adaptive Components**: Leverage AdwToolbarView, AdwActionRow, AdwPreferencesGroup
4. **Information Architecture**: Status information in main content, not action bars
5. **Action Bar Simplicity**: Only essential actions in bottom bars (primary + secondary)
6. **Content Organization**: Use preference groups for logical information grouping

### Mobile-Specific Status Display

**❌ Avoid**: Cramming multiple status items in action bar center areas
```xml
<child type="center">
  <object class="GtkBox">
    <child><object class="GtkLabel">Networks: 5</object></child>
    <child><object class="GtkLabel">GPS: Active</object></child>
  </object>
</child>
```

**✅ Use**: Individual AdwActionRow items in preference groups
```xml
<object class="AdwPreferencesGroup">
  <child>
    <object class="AdwActionRow">
      <property name="title">Network Devices</property>
      <child type="suffix">
        <object class="GtkLabel">1 device</object>
      </child>
    </object>
  </child>
</object>
```

### Mobile UI Patterns

```xml
<!-- ✅ Good: Mobile-optimized button -->
<object class="GtkButton">
  <property name="width-request">48</property>
  <property name="height-request">48</property>
  <style><class name="circular"/></style>
</object>

<!-- ✅ Good: Responsive content -->
<object class="AdwClamp">
  <property name="maximum-size">600</property>
  <property name="tightening-threshold">500</property>
</object>

<!-- ❌ Bad: Desktop-only layout -->
<object class="GtkHeaderBar">
  <child type="start">
    <object class="GtkButton">
      <property name="label">Very Long Button Text</property>
    </object>
  </child>
</object>
```

### Window Sizing Standards

- **Default Size**: 360x640px (mobile portrait)
- **Minimum Size**: 320x480px (smallest mobile screens)  
- **Desktop Adaptation**: Automatically adapts to larger screens
- **Responsive Breakpoints**: Adjust UI elements for screens < 500px width

## Code Guidelines

### WiFi Scanner Modifications

When modifying `wifi_scanner.py`:

```python
# ✅ Good: Passive monitoring approach
access_points = device.get_access_points() 
for ap in access_points:
    # Process cached network data

# ❌ Bad: Active scanning with authentication
device.request_scan_async()  # Only try, don't require success
```

### Error Handling Standards

```python
# ✅ Good: Graceful permission handling
try:
    device.request_scan_async(None, callback, None)
except Exception as e:
    # Continue with passive monitoring - no error messages
    pass

# ❌ Bad: Failing on permission issues  
if "not authorized" in str(e):
    raise Exception("Requires system configuration")
```

### Location Service Integration

```python
# ✅ Good: Direct D-Bus with proper app ID
props_iface.Set('org.freedesktop.GeoClue2.Client', 
                'DesktopId', GLib.Variant('s', 'com.andrewstclair.Wardrive'))

# ❌ Bad: High-level APIs that may require different permissions
geoclue_client = Geoclue.Simple.new_sync(app_id, level)
```

## Common Development Pitfalls

### 1. WiFi Scanning Permissions
- **Problem**: Adding system configuration requirements
- **Solution**: Always use passive monitoring as primary method

### 2. Application ID Consistency  
- **Problem**: Mismatched IDs between files
- **Solution**: Use `com.andrewstclair.Wardrive` consistently (no hyphens!)

### 3. Resource Path Errors
- **Problem**: Resources not found after ID changes
- **Solution**: Update all GResource prefixes to match new ID

### 4. Flatpak Testing
- **Problem**: Only testing native execution
- **Solution**: Always test Flatpak builds for real-world compatibility

## File Naming Conventions

All files must use the consistent application ID format:
- Application ID: `com.andrewstclair.Wardrive` (no hyphens)
- Desktop file: `com.andrewstclair.Wardrive.desktop`
- Metainfo: `com.andrewstclair.Wardrive.metainfo.xml`
- GSchema: `com.andrewstclair.Wardrive.gschema.xml`
- Debian packaging: `debian/` directory structure
- Icons: `com.andrewstclair.Wardrive.svg`

## Success Criteria

A successful implementation must demonstrate:

1. **✅ Clean Startup**: No permission warnings or authentication prompts
2. **✅ Network Detection**: WiFi networks discovered in passive mode  
3. **✅ Location Services**: GPS coordinates obtained via D-Bus
4. **✅ Native Integration**: Direct system access for optimal performance
5. **✅ Cross-Platform**: Works on different Linux distributions
6. **✅ Mobile Compatible**: Functions on phones/tablets with NetworkManager

## Debugging Commands

### Check WiFi Scanning
```bash
# Test basic NetworkManager access
python3 test-wifi-scanning.py

# Manual NetworkManager check  
nmcli device wifi list
```

### Check Location Services
```bash
# Test GeoClue access
busctl --system call org.freedesktop.GeoClue2 \
  /org/freedesktop/GeoClue2/Manager \
  org.freedesktop.GeoClue2.Manager \
  GetClient '{}'
```

### Check Application Resources
```bash
# Verify GResource compilation
gresource list builddir/data/gnome-wardrive.gresource

# Check desktop file validation
desktop-file-validate data/com.andrewstclair.Wardrive.desktop
```

## Version Information

- **GTK Version**: 4.x (minimum 4.14)
- **Libadwaita Version**: 1.x (minimum 1.5)
- **Python Version**: 3.8+ (for PyGObject compatibility)
- **Flatpak Runtime**: org.gnome.Platform//46

Remember: The goal is a **truly portable wardriving application** that works everywhere GNOME runs, without any user configuration required!