# GNOME Wardrive - Copilot Instructions

## Project Overview

GNOME Wardrive is a modern WiFi wardriving application built for the GNOME desktop using Python, GTK4, and Libadwaita. The application is designed to be **completely portable** and work seamlessly inside Flatpak sandboxes without requiring any system configuration changes.

## Core Architecture

### Application Structure
```
src/
├── main.py              # Application entry point
├── application.py       # Main Adwaita.Application class
├── window.py           # Main window with GTK4 template
├── wifi_scanner.py     # Portable WiFi monitoring service
├── location_service.py # GeoClue GPS integration  
├── data_manager.py     # Data export (CSV, KML, GPX)
└── __init__.py

data/
├── ui/
│   ├── window.ui           # Main GTK4 interface
│   └── window_simple.ui    # Simplified interface template
├── com.andrewstclair.Wardrive.yml        # Flatpak manifest
├── com.andrewstclair.Wardrive.gschema.xml # GSettings schema
└── gnome-wardrive.gresource.xml          # UI resources
```

### Key Design Principles

1. **Portable WiFi Scanning**: Uses NetworkManager's passive monitoring approach that works inside Flatpak sandboxes
2. **Native GNOME Integration**: Full D-Bus integration with NetworkManager and GeoClue
3. **Cross-Platform Compatibility**: Works on mobile devices, desktops, and different distributions
4. **No System Configuration**: Zero setup required from users - works out of the box

## Critical Implementation Details

### WiFi Scanning Architecture (IMPORTANT!)

The application uses a **passive WiFi monitoring** approach that is critical for portability:

**❌ DO NOT use active scanning approaches that require:**
- Special user permissions (netdev group)
- PolicyKit rule modifications
- System configuration changes
- Elevated privileges

**✅ DO use the current passive monitoring approach:**
- Monitor NetworkManager's cached access point data
- Attempt active scans but gracefully fall back to passive
- Rely on natural network discovery from beacon frames and system scans
- Works identically inside Flatpak sandboxes

### Location Services Integration

Uses direct D-Bus calls to GeoClue2 with proper application identification:
- Set `DesktopId` property to match application ID
- Set `RequestedAccuracyLevel` for GPS precision
- Handle location updates via D-Bus signals
- Graceful degradation if location services unavailable

### Data Export Formats

Support multiple standard formats for wardriving data:
- **CSV**: Raw tabular data for analysis
- **KML**: Google Earth compatible mapping
- **GPX**: GPS track format with waypoints

## Testing Requirements

### 1. Basic Functionality Test
```bash
# Run the WiFi scanning test
python3 test-wifi-scanning.py

# Expected output: Should detect visible WiFi networks without errors
# ✅ Portable WiFi scanning is working!
```

### 2. Application Launch Test  
```bash
# Quick development test
./quick-test.sh

# Expected: Clean startup with no permission errors
# Should show: "✅ Portable WiFi scanning ready"
```

### 3. Full Development Test
```bash
# Build and run via Meson
meson setup builddir
ninja -C builddir
python3 run-dev.py

# Expected output should include:
# - "Found X WiFi devices"
# - "✅ Location service started successfully" 
# - NO authentication or permission warnings
```

### 4. Flatpak Compatibility Test
```bash
# This must work without system modifications
flatpak-builder --force-clean build-dir com.andrewstclair.Wardrive.yml
flatpak-builder --run build-dir com.andrewstclair.Wardrive.yml gnome-wardrive

# Critical: Must work identically to native execution
```

### 5. CI Artifact Testing
```bash
# Download Flatpak bundle from GitHub Actions artifacts
# Available for every commit on main/develop branches and PRs
# Artifact name: gnome-wardrive-flatpak-{run_number}-{commit_sha}

# Test installation:
flatpak install com.andrewstclair.Wardrive.flatpak
flatpak run com.andrewstclair.Wardrive
```

## Flatpak Portability Requirements

### Mandatory Characteristics

1. **Zero System Configuration**: Application must work immediately after Flatpak installation
2. **Sandbox Compatible**: Full functionality within Flatpak's security model
3. **Permission Minimal**: Only request essential D-Bus permissions
4. **Graceful Degradation**: Handle permission denials without breaking

### Required Flatpak Permissions

```yaml
finish-args:
  - --share=network                                    # Network access
  - --system-talk-name=org.freedesktop.NetworkManager # WiFi monitoring  
  - --system-talk-name=org.freedesktop.GeoClue2      # GPS location
  - --filesystem=home                                  # Data export
  - --socket=wayland                                   # Display
  - --socket=fallback-x11                             # X11 fallback
  - --share=ipc                                        # IPC for GUI
  - --device=dri                                       # Hardware acceleration
```

**❌ NEVER add these permissions** (breaks portability):
- `--filesystem=host` (too broad)
- `--system-talk-name=org.freedesktop.PolicyKit1` (requires system changes)
- `--device=all` (security risk)

### Testing Flatpak Portability

When making changes, always verify:

1. **No Permission Errors**: Application starts clean in sandbox
2. **WiFi Detection Works**: Networks discovered without active scan permissions
3. **Location Services Work**: GPS coordinates obtained via GeoClue D-Bus
4. **Data Export Works**: Files can be saved to user's home directory
5. **UI Responsive**: GTK4/Libadwaita interface works properly

## Code Guidelines

### WiFi Scanner Modifications

When modifying `wifi_scanner.py`:

```python
# ✅ Good: Passive monitoring approach
access_points = device.get_access_points() 
for ap in access_points:
    # Process cached network data

# ❌ Bad: Active scanning with authentication
device.request_scan_async()  # Only try, don't require success
```

### Error Handling Standards

```python
# ✅ Good: Graceful permission handling
try:
    device.request_scan_async(None, callback, None)
except Exception as e:
    # Continue with passive monitoring - no error messages
    pass

# ❌ Bad: Failing on permission issues  
if "not authorized" in str(e):
    raise Exception("Requires system configuration")
```

### Location Service Integration

```python
# ✅ Good: Direct D-Bus with proper app ID
props_iface.Set('org.freedesktop.GeoClue2.Client', 
                'DesktopId', GLib.Variant('s', 'com.andrewstclair.Wardrive'))

# ❌ Bad: High-level APIs that may require different permissions
geoclue_client = Geoclue.Simple.new_sync(app_id, level)
```

## Common Development Pitfalls

### 1. WiFi Scanning Permissions
- **Problem**: Adding system configuration requirements
- **Solution**: Always use passive monitoring as primary method

### 2. Application ID Consistency  
- **Problem**: Mismatched IDs between files
- **Solution**: Use `com.andrewstclair.Wardrive` consistently (no hyphens!)

### 3. Resource Path Errors
- **Problem**: Resources not found after ID changes
- **Solution**: Update all GResource prefixes to match new ID

### 4. Flatpak Testing
- **Problem**: Only testing native execution
- **Solution**: Always test Flatpak builds for real-world compatibility

## File Naming Conventions

All files must use the consistent application ID format:
- Application ID: `com.andrewstclair.Wardrive` (no hyphens)
- Desktop file: `com.andrewstclair.Wardrive.desktop`
- Metainfo: `com.andrewstclair.Wardrive.metainfo.xml`
- GSchema: `com.andrewstclair.Wardrive.gschema.xml`
- Flatpak manifest: `com.andrewstclair.Wardrive.yml`
- Icons: `com.andrewstclair.Wardrive.svg`

## Success Criteria

A successful implementation must demonstrate:

1. **✅ Clean Startup**: No permission warnings or authentication prompts
2. **✅ Network Detection**: WiFi networks discovered in passive mode  
3. **✅ Location Services**: GPS coordinates obtained via D-Bus
4. **✅ Flatpak Ready**: Identical behavior in sandbox vs native
5. **✅ Cross-Platform**: Works on different Linux distributions
6. **✅ Mobile Compatible**: Functions on phones/tablets with NetworkManager

## Debugging Commands

### Check WiFi Scanning
```bash
# Test basic NetworkManager access
python3 test-wifi-scanning.py

# Manual NetworkManager check  
nmcli device wifi list
```

### Check Location Services
```bash
# Test GeoClue access
busctl --system call org.freedesktop.GeoClue2 \
  /org/freedesktop/GeoClue2/Manager \
  org.freedesktop.GeoClue2.Manager \
  GetClient '{}'
```

### Check Application Resources
```bash
# Verify GResource compilation
gresource list builddir/data/gnome-wardrive.gresource

# Check desktop file validation
desktop-file-validate data/com.andrewstclair.Wardrive.desktop
```

## Version Information

- **GTK Version**: 4.x (minimum 4.14)
- **Libadwaita Version**: 1.x (minimum 1.5)
- **Python Version**: 3.8+ (for PyGObject compatibility)
- **Flatpak Runtime**: org.gnome.Platform//48

Remember: The goal is a **truly portable wardriving application** that works everywhere GNOME runs, without any user configuration required!