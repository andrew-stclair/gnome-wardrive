name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-gi python-gi-dev libgtk-4-dev libadwaita-1-dev gir1.2-gtk-4.0 \
          gir1.2-adw-1 gir1.2-nm-1.0 gir1.2-geoclue-2.0 meson ninja-build python3-requests python3-gpxpy \
          gettext desktop-file-utils appstream-util
    
    - name: Build and test
      run: |
        meson setup builddir
        meson compile -C builddir
        
        # Test basic imports (WiFi scanning won't work in CI without hardware)
        python3 -c "import sys; sys.path.insert(0, 'src'); import main; print('‚úÖ main.py imports successfully')"
        
        # Test that the built executable exists
        if [ -f builddir/src/gnome-wardrive ]; then
          echo "‚úÖ Executable built successfully"
        else
          echo "‚ùå Executable not found"
          exit 1
        fi

  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y debhelper dh-python python3-all meson ninja-build pkg-config \
          libgtk-4-dev libadwaita-1-dev python-gi-dev gir1.2-gtk-4.0 gir1.2-adw-1 \
          gir1.2-nm-1.0 gir1.2-geoclue-2.0 libnm-dev libglib2.0-dev desktop-file-utils \
          appstream-util build-essential devscripts python3-requests python3-gpxpy gettext
    
    - name: Build Debian package
      run: |
        export DEBEMAIL="github-actions@example.com"
        export DEBFULLNAME="GitHub Actions"
        
        # Set up meson build first to ensure everything is configured
        meson setup builddir --buildtype=release
        
        # Build the Debian package using debuild (architecture-independent)
        debuild -us -uc -b
        
        # Verify the package was built and contains the application
        if [ -f ../gnome-wardrive_*.deb ]; then
          echo "‚úÖ Package built successfully:"
          ls -la ../gnome-wardrive_*.deb
          echo "üìã Package contents:"
          dpkg-deb --contents ../gnome-wardrive_*.deb | grep -E "(gnome-wardrive|\.py)" || echo "No Python files found in package!"
          
          # Test package installation in isolated environment
          echo "üß™ Testing package installation..."
          sudo dpkg -i ../gnome-wardrive_*.deb || echo "Package installation failed, trying to fix dependencies..."
          sudo apt-get install -f -y
          
          # Test that the executable exists and can import properly
          echo "üîç Testing executable..."
          if command -v gnome-wardrive >/dev/null 2>&1; then
            echo "‚úÖ gnome-wardrive executable found in PATH"
            # Test imports (but don't start GUI)
            python3 -c "import sys; sys.path.insert(0, '/usr/share/gnome-wardrive'); import gnome_wardrive.main; print('‚úÖ Application modules import successfully')" || echo "‚ö†Ô∏è Import test failed"
          else
            echo "‚ùå gnome-wardrive executable not found!"
            exit 1
          fi
        else
          echo "‚ùå No .deb package found!"
          exit 1
        fi
    
    - name: Upload Debian package
      uses: actions/upload-artifact@v4
      with:
        name: gnome-wardrive-deb
        path: ../*.deb
        retention-days: 30
    
