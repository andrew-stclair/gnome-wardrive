name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3-gi \
          python3-gi-cairo \
          gir1.2-gtk-4.0 \
          gir1.2-adw-1 \
          gir1.2-nm-1.0 \
          gir1.2-geoclue-2.0 \
          libgtk-4-dev \
          libadwaita-1-dev \
          python-gi-dev \
          meson \
          ninja-build \
          appstream-util \
          desktop-file-utils \
          libglib2.0-bin
    
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
    
    - name: Setup build directory
      run: meson setup builddir
    
    - name: Build
      run: meson compile -C builddir
    
    - name: Test
      run: meson test -C builddir

  flatpak:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-46
      options: --privileged
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: flatpak/flatpak-github-actions/flatpak-builder@v6
      with:
        bundle: com.andrewstclair.Wardrive.flatpak
        manifest-path: com.andrewstclair.Wardrive.yml
        cache-key: flatpak-builder-${{ github.sha }}
    
    - name: Create build info
      run: |
        echo "Build Information" > build-info.txt
        echo "=================" >> build-info.txt
        echo "Repository: ${{ github.repository }}" >> build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Build Number: ${{ github.run_number }}" >> build-info.txt
        echo "Build Date: $(date -u)" >> build-info.txt
        echo "GNOME Platform: 46" >> build-info.txt
        echo "" >> build-info.txt
        echo "Installation Instructions:" >> build-info.txt
        echo "1. Download the .flatpak file" >> build-info.txt
        echo "2. Install with: flatpak install com.andrewstclair.Wardrive.flatpak" >> build-info.txt
        echo "3. Run with: flatpak run com.andrewstclair.Wardrive" >> build-info.txt
    
    - name: Upload Flatpak bundle
      uses: actions/upload-artifact@v4
      with:
        name: gnome-wardrive-flatpak-${{ github.run_number }}-${{ github.sha }}
        path: |
          com.andrewstclair.Wardrive.flatpak
          build-info.txt
        retention-days: 30
        compression-level: 6
        if-no-files-found: error
    
    - name: Build Summary
      run: |
        echo "## 📦 Flatpak Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Build Status**: Success" >> $GITHUB_STEP_SUMMARY
        echo "📋 **Artifact Name**: gnome-wardrive-flatpak-${{ github.run_number }}-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "🏷️ **GNOME Platform**: 46" >> $GITHUB_STEP_SUMMARY
        echo "📅 **Build Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🚀 Testing Instructions" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the artifact from the Actions tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract the .flatpak file" >> $GITHUB_STEP_SUMMARY
        echo "3. Install: \`flatpak install com.andrewstclair.Wardrive.flatpak\`" >> $GITHUB_STEP_SUMMARY
        echo "4. Run: \`flatpak run com.andrewstclair.Wardrive\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✨ Features to Test" >> $GITHUB_STEP_SUMMARY
        echo "- 📡 Portable WiFi scanning (should work without permissions)" >> $GITHUB_STEP_SUMMARY
        echo "- 📍 GPS location tracking via GeoClue" >> $GITHUB_STEP_SUMMARY
        echo "- 💾 Data export (CSV, KML, GPX formats)" >> $GITHUB_STEP_SUMMARY
        echo "- 🎨 Modern GTK4/Libadwaita interface" >> $GITHUB_STEP_SUMMARY