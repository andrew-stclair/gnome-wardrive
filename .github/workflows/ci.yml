name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-gi python-gi-dev libgtk-4-dev libadwaita-1-dev gir1.2-gtk-4.0 \
          gir1.2-adw-1 gir1.2-nm-1.0 gir1.2-geoclue-2.0 meson ninja-build python3-requests python3-gpxpy \
          gettext desktop-file-utils appstream-util
    
    - name: Build and test
      run: |
        meson setup builddir
        meson compile -C builddir
        
        # Test basic imports (WiFi scanning won't work in CI without hardware)
        python3 test_setup.py
        
        # Test that the built executable exists
        if [ -f builddir/src/gnome-wardrive ]; then
          echo "‚úÖ Executable built successfully"
        else
          echo "‚ùå Executable not found"
          exit 1
        fi

  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y debhelper dh-python python3-all meson ninja-build pkg-config \
          libgtk-4-dev libadwaita-1-dev python-gi-dev gir1.2-gtk-4.0 gir1.2-adw-1 \
          gir1.2-nm-1.0 gir1.2-geoclue-2.0 libnm-dev libglib2.0-dev desktop-file-utils \
          appstream-util build-essential devscripts python3-requests python3-gpxpy gettext
    
    - name: Build Debian package
      run: |
        export DEBEMAIL="${{ vars.OWNER_EMAIL }}"
        export DEBFULLNAME="${{ vars.OWNER_NAME }}"
        
        # Set up meson build first to ensure everything is configured
        meson setup builddir --buildtype=release
        
        # Build the Debian package using debuild (architecture-independent)
        debuild -us -uc -b
        
        # Move .deb file to workspace for artifact upload
        echo "üì¶ Moving .deb files to workspace..."
        mv ../*.deb . || echo "Warning: Could not move .deb files"
        ls -la *.deb || echo "No .deb files found in workspace after move"
        
        # Verify the package was built and contains the application
        if [ -f gnome-wardrive_*.deb ]; then
          echo "‚úÖ Package built successfully:"
          ls -la gnome-wardrive_*.deb
          echo "üìã Package contents:"
          dpkg-deb --contents gnome-wardrive_*.deb | grep -E "(gnome-wardrive|\.py)" || echo "No Python files found in package!"
          
          # Test package installation in isolated environment
          echo "üß™ Testing package installation..."
          sudo dpkg -i gnome-wardrive_*.deb || echo "Package installation failed, trying to fix dependencies..."
          sudo apt-get install -f -y
          
          # Test that the executable exists and is properly installed
          echo "üîç Testing executable..."
          if command -v gnome-wardrive >/dev/null 2>&1; then
            echo "‚úÖ gnome-wardrive executable found in PATH"
            echo "üìç Executable location: $(which gnome-wardrive)"
            
            # Verify the gresource file is installed
            if [ -f /usr/share/gnome-wardrive/gnome-wardrive.gresource ]; then
              echo "‚úÖ GResource file found"
            else
              echo "‚ùå GResource file not found at /usr/share/gnome-wardrive/gnome-wardrive.gresource"
              echo "Contents of /usr/share/gnome-wardrive/:"
              ls -la /usr/share/gnome-wardrive/ || echo "Directory not found"
              exit 1
            fi
            
            # Verify Python modules are installed
            if [ -d /usr/share/gnome-wardrive/gnome_wardrive ]; then
              echo "‚úÖ Python modules directory found"
              echo "üì¶ Installed modules:"
              ls -la /usr/share/gnome-wardrive/gnome_wardrive/
            else
              echo "‚ùå Python modules not found!"
              exit 1
            fi
          else
            echo "‚ùå gnome-wardrive executable not found!"
            exit 1
          fi
        else
          echo "‚ùå No .deb package found!"
          ls -la . || true
          ls -la .. || true
          exit 1
        fi
    
    - name: Upload Debian package
      uses: actions/upload-artifact@v4
      if: always()  # Upload even if tests fail
      with:
        name: gnome-wardrive-deb
        path: "*.deb"
        if-no-files-found: warn
        retention-days: 30
    
