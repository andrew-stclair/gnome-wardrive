name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64  
            runner: ubuntu-24.04-arm
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Flatpak dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          flatpak \
          flatpak-builder \
          build-essential \
          git \
          ccache \
          appstream-util \
          desktop-file-utils \
          elfutils \
          python3-aiohttp \
          python3-tenacity \
          gettext \
          shared-mime-info
        
        # Add Flathub remote
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        
        # Install required SDKs and runtimes
        sudo flatpak install -y flathub org.freedesktop.Platform//22.08 org.freedesktop.Sdk//22.08
        sudo flatpak install -y flathub org.gnome.Platform//47 org.gnome.Sdk//47
    
    - name: Build Flatpak
      uses: flatpak/flatpak-github-actions/flatpak-builder@v6
      with:
        bundle: com.andrewstclair.Wardrive-${{ matrix.arch }}.flatpak
        manifest-path: com.andrewstclair.Wardrive.yml
        cache-key: flatpak-builder-${{ matrix.arch }}-${{ github.sha }}
        arch: ${{ matrix.arch }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-${{ matrix.arch }}
        path: com.andrewstclair.Wardrive-${{ matrix.arch }}.flatpak
        retention-days: 1
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          artifacts/flatpak-x86_64/com.andrewstclair.Wardrive-x86_64.flatpak
          artifacts/flatpak-aarch64/com.andrewstclair.Wardrive-aarch64.flatpak
        body: |
          ## GNOME Wardrive ${{ github.ref_name }}
          
          A modern GNOME WiFi wardriving application with mobile-first design.
          
          ### üì¶ Multi-Architecture Support
          
          This release includes Flatpak bundles for multiple architectures:
          - **x86_64**: For Intel/AMD 64-bit systems (most desktops/laptops)  
          - **aarch64**: For ARM 64-bit systems (mobile devices, ARM SBCs)
          
          ### üöÄ Installation
          
          1. Download the appropriate .flatpak file for your architecture
          2. Install: `flatpak install com.andrewstclair.Wardrive-{arch}.flatpak`
          3. Run: `flatpak run com.andrewstclair.Wardrive`
          
          ### ‚ú® Features
          
          - üì° Portable WiFi scanning (works in Flatpak sandboxes)
          - üìç GPS location tracking via GeoClue  
          - üíæ Multiple export formats (CSV, KML, GPX)
          - üé® Modern GTK4/Libadwaita interface
          - üì± Mobile-optimized responsive design
          
          ### üîß System Requirements
          
          - Flatpak runtime support
          - GNOME Platform 47
          - NetworkManager (for WiFi scanning)
          - GeoClue2 (for GPS location)
          
          ### üèóÔ∏è Architecture Detection
          
          If you're unsure which architecture to download:
          - Run `uname -m` to check your system architecture
          - `x86_64` = Download the x86_64 version
          - `aarch64` or `arm64` = Download the aarch64 version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}